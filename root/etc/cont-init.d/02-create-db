#!/bin/sh
# Create database and enable extensions after postgres is initialized
# This script prepares a SQL file that will be run on first connect

PGDATA="${PGDATA:-/config/data}"
INIT_FILE="$PGDATA/init-extensions.sql"

# Skip if init file already processed
if [ -f "$PGDATA/.extensions_done" ]; then
    echo "Extensions already configured."
    exit 0
fi

# Create init SQL for extensions and database
cat > "$INIT_FILE" << 'EOF'
-- Enable Immich required extensions
CREATE EXTENSION IF NOT EXISTS vector;    -- pgvector
CREATE EXTENSION IF NOT EXISTS vchord;    -- VectorChord
CREATE EXTENSION IF NOT EXISTS pg_trgm;   -- trigram text search
EOF

# If a custom database is requested, add creation
if [ -n "${POSTGRES_DB}" ] && [ "${POSTGRES_DB}" != "postgres" ]; then
    echo "SELECT 'CREATE DATABASE ${POSTGRES_DB}' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '${POSTGRES_DB}')\\gexec" >> "$INIT_FILE"
fi

chown bsd:bsd "$INIT_FILE"

echo "Database init SQL prepared at $INIT_FILE"
echo "Run manually after first start: psql -f $INIT_FILE"
